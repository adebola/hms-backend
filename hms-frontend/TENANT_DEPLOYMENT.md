# HMS Frontend - Tenant-Specific Deployment Guide

## Overview

Each hospital/tenant gets their own frontend deployment pre-configured for their tenant. Users only need to enter **username and password** - the tenant code is hard-coded in the deployment configuration.

## Architecture

```
┌─────────────────────────────────────────────────────┐
│  hospitalA.hms.com  →  HOSPITAL_A tenant            │
│  clinicB.hms.com    →  CLINIC_B tenant              │
│  labC.hms.com       →  LAB_C tenant                 │
└─────────────────────────────────────────────────────┘
                        ↓
            Auth Server validates credentials
            Returns tenant-scoped JWT tokens
```

## Key Features

✅ **No tenant code input** - Users only enter username/password
✅ **Pre-configured per deployment** - Each deployment tied to one tenant
✅ **No secrets exposed** - No OAuth2 client secrets in frontend
✅ **Simple build process** - One command per tenant
✅ **Subdomain detection** - Optional auto-detection from subdomain (dev only)

## Building Tenant-Specific Deployments

### Single Tenant Build

```bash
# Build for a specific tenant
./build-tenant.sh HOSPITAL_A

# Build with custom OAuth2 client ID
./build-tenant.sh HOSPITAL_A hospital-a-web-client

# Build for multiple tenants
./build-tenant.sh CLINIC_B
./build-tenant.sh LAB_C
```

### Build Output

Each build creates a deployment in `dist/TENANT_CODE/`:

```
dist/
├── HOSPITAL_A/
│   ├── index.html
│   ├── main.*.js (contains hard-coded HOSPITAL_A tenant code)
│   └── ...
├── CLINIC_B/
│   ├── index.html
│   ├── main.*.js (contains hard-coded CLINIC_B tenant code)
│   └── ...
└── LAB_C/
    └── ...
```

## Deployment Process

### Step 1: Build for Tenant

```bash
./build-tenant.sh HOSPITAL_A
```

### Step 2: Deploy to Web Server

```bash
# Copy to web server
scp -r dist/HOSPITAL_A/* user@server:/var/www/hospitala.hms.com/

# Or use rsync
rsync -avz dist/HOSPITAL_A/ user@server:/var/www/hospitala.hms.com/
```

### Step 3: Configure Web Server

#### Nginx Configuration Example

```nginx
server {
    listen 443 ssl http2;
    server_name hospitala.hms.com;

    ssl_certificate /etc/ssl/certs/hospitala.hms.com.crt;
    ssl_certificate_key /etc/ssl/private/hospitala.hms.com.key;

    root /var/www/hospitala.hms.com;
    index index.html;

    # Frontend routes (Angular routing)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API proxy (optional - if not using direct gateway URL)
    location /api/ {
        proxy_pass https://gateway.hms-platform.com;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### Step 4: Configure DNS

Point subdomain to your server:

```
hospitala.hms.com  →  A record  →  Your server IP
clinicb.hms.com    →  A record  →  Your server IP
labc.hms.com       →  A record  →  Your server IP
```

### Step 5: Test Deployment

1. Navigate to `https://hospitala.hms.com/login`
2. Verify tenant branding loads correctly
3. Login with username/password only (no tenant code field)
4. Verify successful authentication

## Environment Configuration

### Development Environment (`environment.ts`)

```typescript
export const environment = {
  production: false,
  apiUrl: 'http://localhost:8080',

  tenant: {
    code: 'DEFAULT',
    autoDetectFromSubdomain: true,  // Auto-detect in dev
  },

  oauth: {
    clientId: 'default-web-client',
  }
};
```

### Production Environment (Generated by `build-tenant.sh`)

```typescript
export const environment = {
  production: true,
  apiUrl: 'https://gateway.hms-platform.com',

  tenant: {
    code: 'HOSPITAL_A',  // Hard-coded per deployment
    autoDetectFromSubdomain: false,
  },

  oauth: {
    clientId: 'hospital-a-web-client',
  }
};
```

## Login Flow

### Before (Multi-Tenant Input)
```
┌─────────────────────┐
│ Tenant Code: [___] │ ← User had to enter
│ Username:    [___] │
│ Password:    [___] │
└─────────────────────┘
```

### After (Pre-Configured)
```
┌─────────────────────┐
│ Username:    [___] │ ← Only these fields
│ Password:    [___] │
└─────────────────────┘
(Tenant code: HOSPITAL_A - pre-configured)
```

## Security Considerations

### ✅ What's Safe

- **Tenant Code**: Public identifier, safe to embed
- **OAuth2 Client ID**: Public identifier, safe to embed
- **API URL**: Public endpoint, safe to embed

### ❌ What's NOT Included

- **OAuth2 Client Secret**: NEVER in frontend (stored in backend only)
- **Private Keys**: Not in frontend code
- **Database Credentials**: Not in frontend code

### Authentication Flow

```
1. User enters username/password
2. Frontend calls: POST /api/v1/auth/login
   {
     "tenantCode": "HOSPITAL_A",  // Pre-configured
     "username": "doctor1",
     "password": "***"
   }
3. Backend validates credentials
4. Backend returns JWT tokens (no client secret needed)
5. Frontend stores tokens in localStorage
```

## Troubleshooting

### Issue: Login shows "Invalid tenant code"

**Solution**: Verify tenant code is correct in build configuration

```bash
# Check embedded tenant code
cat dist/HOSPITAL_A/main.*.js | grep -o "HOSPITAL_A"
```

### Issue: Branding not loading

**Solution**: Verify tenant branding API endpoint is accessible

```bash
# Test branding endpoint
curl https://gateway.hms-platform.com/api/v1/tenants/HOSPITAL_A/branding
```

### Issue: Different tenant code in dev vs production

**Solution**: Dev uses `autoDetectFromSubdomain: true`, production uses hard-coded value

```typescript
// Development (subdomain detection enabled)
tenant: {
  code: 'DEFAULT',
  autoDetectFromSubdomain: true,  // Will use subdomain if available
}

// Production (hard-coded only)
tenant: {
  code: 'HOSPITAL_A',
  autoDetectFromSubdomain: false,  // Always use HOSPITAL_A
}
```

## Multi-Tenant Build Script

Create `build-all-tenants.sh` for building multiple tenants at once:

```bash
#!/bin/bash

tenants=(
  "HOSPITAL_A:hospital-a-web-client"
  "CLINIC_B:clinic-b-web-client"
  "LAB_C:lab-c-web-client"
)

for entry in "${tenants[@]}"; do
  IFS=':' read -r tenant_code client_id <<< "$entry"
  echo "Building $tenant_code..."
  ./build-tenant.sh "$tenant_code" "$client_id"
done

echo "All tenant builds complete!"
```

## Deployment Checklist

- [ ] Backend OAuth2 client created for tenant
- [ ] Tenant registered in authorization server
- [ ] Build frontend for tenant: `./build-tenant.sh TENANT_CODE`
- [ ] Deploy to web server: `/var/www/tenant.hms.com/`
- [ ] Configure Nginx virtual host
- [ ] Configure DNS A record
- [ ] SSL certificate installed
- [ ] Test login flow
- [ ] Verify tenant branding
- [ ] Test user permissions

## Future: Tenant Admin Application

For platform administration (managing ALL tenants), deploy a separate admin frontend:

```bash
# Admin frontend (no tenant pre-configuration)
./build-admin.sh

# Deployed at: admin.hms.com
# Uses SUPER_ADMIN authentication
# Can manage all tenants from one interface
```

## References

- Main documentation: `/hms-backend/CLAUDE.md`
- Environment config: `/hms-frontend/src/environments/`
- Login component: `/hms-frontend/src/app/features/auth/login/`
- Build script: `/hms-frontend/build-tenant.sh`
